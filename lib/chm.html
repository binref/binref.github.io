<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.11.6" />
<title>the refinery.lib.chm documentation</title>
<meta name="description" content="On a Mission to Refine Binaries" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night-bright.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{background-color:#0D0D0D;color:#EEEEEE;font-size:16pt}@font-face{font-family:"FixedSysEx";src:local('Fixedsys Excelsior 3.01-L2'),local('Fixedsys Excelsior 3.01'),local('FixedSysEx'),url(../FixedSysEx.ttf) format('truetype')}code,pre,body,html{font-family:FixedSysEx,monospace}b,strong{font-weight:normal}#content{padding:20px}#sidebar{padding:1vw;overflow:hidden}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #EEEEEE;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}hr{display:none}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#EE8080;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#EEEEEE}// .title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#BB4040}pre code{background:#000000;display:block;padding:1px 0px 4px 0px;line-height:100%}code{background:#000000;padding:1px 0px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#000000;border:0;border-top:1px solid #EEEEEE;border-bottom:1px solid #EEEEEE;margin:1em 0;padding:1ex;overflow-x:auto}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index ul{list-style-type:square;padding:0}// #index h4{font-weight:bold}#index h4 + ul{margin-bottom:.6em}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 10px}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#000000;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#0D0D0D}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#EEEEEE;border-left:5px solid #EEEEEE;padding-left:1em}.inheritance em{font-style:normal}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1ch}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition.note,.admonition.info,.admonition.todo,.admonition.versionadded,.admonition.important,.admonition.tip,.admonition.hint{background:#054000}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#998800}.admonition.error,.admonition.danger,.admonition.caution{background:#300000}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%}#content{width:70%;max-width:100ch;padding:1vw}main{display:flex;flex-direction:row;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #EEEEEE;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>refinery.lib.chm</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L1-L377" class="git-link">Browse git</a>
</summary>
<pre><code class="python">from __future__ import annotations

import codecs
import math

from dataclasses import dataclass, field
from functools import cached_property
from typing import ClassVar
from uuid import UUID

from refinery.lib.lcid import DEFAULT_CODEPAGE, LCID
from refinery.lib.lzx import LzxDecoder
from refinery.lib.structures import Struct, StructReader

_LZX_HLP = UUID(&#39;0a9007c6-4076-11d3-8789-0000f8105754&#39;)
_LZX_CHM = UUID(&#39;7fc28940-9d31-11d0-9b27-00a0c91e9c7c&#39;)


class SectionHeader(Struct):
    def __init__(self, reader: StructReader[memoryview]):
        self.offset = reader.u64()
        self.length = reader.u64()


class LanguageMixin:
    language: int

    @cached_property
    def codepage(self):
        return DEFAULT_CODEPAGE.get(self.language, None)

    @cached_property
    def language_name(self):
        return LCID.get(self.language, &#39;Unknown&#39;)


class ChmStruct(Struct):
    Magic: ClassVar[bytes]

    def _check_magic(self, reader: StructReader):
        if (s := reader.peek(len(self.Magic))) != self.Magic:
            raise InvalidMagic(self, s)


class InvalidMagic(ValueError):
    def __init__(self, who: ChmStruct, magic: memoryview):
        super().__init__(
            F&#39;Invalid {who.__class__.__name__} signature {magic.hex(&#34;:&#34;).upper()}, &#39;
            F&#39;should be {who.Magic.hex(&#34;:&#34;).upper()}.&#39;)


class ChmHeader(ChmStruct, LanguageMixin):

    Magic = B&#39;ITSF&#39;
    Guid = UUID(&#39;7C01FD10-7BAA-11D0-9E0C-00A0-C922-E6EC&#39;)

    def __init__(self, reader: StructReader[memoryview]):
        self._check_magic(reader)
        self.signature = reader.read_bytes(4)
        self.version = v = reader.u32()
        if v &lt; 3:
            raise NotImplementedError(F&#39;Parsing of HelpV{v} not yet implemented.&#39;)
        self.header_size = reader.u32()
        self.unknown = reader.u32()
        self.timestamp = reader.u32()
        self.language = reader.u32()
        self.guid1 = reader.read_guid()
        self.guid2 = reader.read_guid()
        self.section_file_size = SectionHeader(reader)
        self.section_directory = SectionHeader(reader)
        self.content_offset = reader.u64() if v &gt;= 3 else None


class FileSizeHeader(ChmStruct):

    Magic = B&#39;\xFE\x01\0\0&#39;

    def __init__(self, reader: StructReader[memoryview]):
        self._check_magic(reader)
        self.signature = reader.u32()
        reader.skip(4)
        self.file_size = reader.u64()
        reader.skip(8)


class DirectoryHeader(ChmStruct, LanguageMixin):

    Magic = B&#39;ITSP\x01\0\0\0&#39;
    Guid = UUID(&#39;5D02926A-212E-11D0-9DF9-00A0C922E6EC&#39;)

    def __init__(self, reader: StructReader[memoryview]):
        self._check_magic(reader)
        self.signature = reader.read_bytes(4)
        self.version = reader.u32()
        if self.version != 1:
            raise NotImplementedError
        self.header_length_1 = reader.u32()
        reader.skip(4)
        self.chunk_size = reader.u32()
        self.density = reader.u32()
        self.tree_depth = reader.u32()
        self.root_chunk = reader.u32()
        self.listing1st = reader.u32()
        self.listingLst = reader.u32()
        reader.skip(4)
        self.total_chunks = reader.u32()
        self.language = reader.u32()
        if reader.read_guid() != self.Guid:
            raise NotImplementedError
        self.header_length_2 = reader.u32()
        reader.skip(12)


class QuickRefArea(Struct):
    def __init__(self, reader: StructReader, n: int, count: int):
        self.offsets = {
            (k * n): reader.u16() for k in range(count, 0, -1)
        }
        self.num_entries = reader.u16()


class DirectoryListingEntry(Struct):

    def __init__(self, reader: StructReader):
        ns = reader.read_7bit_encoded_int(64, bigendian=True)
        self.name = reader.read_bytes(ns).decode(&#39;utf8&#39;)
        self.section_index = reader.read_7bit_encoded_int(64, bigendian=True)
        self.offset = reader.read_7bit_encoded_int(64, bigendian=True)
        self.length = reader.read_7bit_encoded_int(64, bigendian=True)


class Chunk(ChmStruct):

    def __init__(self, reader: StructReader, density: int):
        self._check_magic(reader)
        self.density = density
        with reader.detour_from_end(-2):
            self.num_entries = reader.u16()
        self.signature = reader.read_bytes(4)
        self.extra_size = reader.u32()

    def _quick_refs(self, reader: StructReader, density: int):
        n = 1 + (1 &lt;&lt; density)
        count = self.num_entries // n
        skips = reader.remaining_bytes - 2 * (count + 1)
        while skips &lt; 0:
            count -= 1
            skips += 2
        reader.skip(skips)
        self.quickref = QuickRefArea(reader, n, count)
        if self.quickref.num_entries != self.num_entries:
            raise ValueError


class IndexChunk(Chunk):

    Magic = B&#39;PMGI&#39;

    def __init__(self, reader: StructReader, density: int):
        super().__init__(reader, density)
        self._quick_refs(reader, density)


class ListingChunk(Chunk):

    Magic = B&#39;PMGL&#39;

    def __init__(self, reader: StructReader, density: int):
        super().__init__(reader, density)
        reader.skip(4)
        self.nr_prev = reader.u32()
        self.nr_next = reader.u32()
        self.entries = [
            DirectoryListingEntry(reader) for _ in range(self.num_entries)]
        self._quick_refs(reader, density)


class ContentSectionsName(Struct):
    def __init__(self, reader: StructReader):
        name = reader.read_length_prefixed(16, block_size=2)
        self.name = codecs.decode(name, &#39;utf-16le&#39;)
        if (t := reader.u16()) != 0:
            raise ValueError(F&#39;Expected a zero WORD after content section name, got 0x{t:X}.&#39;)

    @property
    def path(self):
        return F&#39;::DataSpace/Storage/{self.name}/&#39;

    @property
    def path_content(self):
        return F&#39;{self.path}Content&#39;

    @property
    def path_ctrl_data(self):
        return F&#39;{self.path}ControlData&#39;

    @property
    def path_span_info(self):
        return F&#39;{self.path}SpanInfo&#39;

    def path_reset_table(self, guid: UUID):
        return F&#39;{self.path}Transform/{{{str(guid).upper()}}}/InstanceData/ResetTable&#39;


class ContentSections(Struct):
    def __init__(self, reader: StructReader):
        self.file_size = reader.u16()
        self.sections = [ContentSectionsName(reader) for _ in range(reader.u16())]


class ContentSectionsControlData(ChmStruct):

    Magic = b&#39;LZXC&#39;

    def __init__(self, reader: StructReader[memoryview]):
        # Number of DWORDs following &#39;LZXC&#39;: Must be 6 if version is 2
        self.field_count = reader.u32()
        self._check_magic(reader)
        self.signature = reader.read_bytes(4)
        self.version = reader.u32()
        self.reset_interval = reader.u32()
        self.window_size = reader.u32()
        self.cache_size = reader.u32()
        if (unknowns := self.field_count - 5) &gt; 0:
            self.extra = [reader.u32() for _ in range(unknowns)]


class ContentSectionsResetTable(Struct):

    def __init__(self, reader: StructReader[memoryview]):
        start = reader.tell()
        self.version = reader.u32()
        if self.version not in {2, 3}:
            raise NotImplementedError
        n = reader.u32()
        if reader.u32() != 8:
            raise NotImplementedError
        self.header_size = reader.u32()
        self.size_uncompressed = reader.u64()
        self.size_compressed = reader.u64()
        self.block_size = reader.u64()
        if reader.tell() != self.header_size + start:
            raise NotImplementedError
        self.entries = [reader.u64() for _ in range(n)]


@dataclass
class ContentSection:
    offset: int
    length: int
    base_section: int | None = None
    uncompressed: int | None = None
    window_size: int = 0
    reset_interval: int = 0
    block_size: int = 0
    block_offsets: list = field(default_factory=list)


class CHM(Struct):

    def read_section(self, index: int) -&gt; memoryview:
        try:
            return self.section_data[index]
        except KeyError:
            cs = self.sections[index]
        if cs.base_section is None:
            with self.reader.detour(cs.offset):
                data = self.reader.read(cs.length)
        else:
            data = self.read_section(cs.base_section)[cs.offset:][:cs.length]
        if cs.window_size and cs.block_offsets:
            lzx = LzxDecoder()
            out = bytearray()
            lzx.set_params_and_alloc(cs.window_size)
            for nr, offset in enumerate(cs.block_offsets):
                if nr % cs.reset_interval == 0:
                    lzx.keep_history = False
                if nr &lt; len(cs.block_offsets) - 1:
                    length = cs.block_offsets[nr + 1] - offset
                else:
                    length = len(data) - offset
                out.extend(lzx.decompress(data[offset:][:length], cs.block_size))
                lzx.keep_history = True
            data = memoryview(out)
        self.section_data[index] = data
        return data

    def read(self, entry: DirectoryListingEntry):
        data = self.read_section(entry.section_index)
        return data[entry.offset:][:entry.length]

    def seekto(self, reader: StructReader, path: str):
        if content := self.filesystem.get(path):
            reader.seekset(self.sections[content.section_index].offset + content.offset)
            return True
        else:
            return False

    def __init__(self, reader: StructReader[memoryview], *args, **kwargs):
        self.filesystem: dict[str, DirectoryListingEntry] = {}
        self.sections: list[ContentSection] = []
        self.section_data: dict[int, memoryview] = {}

        self.reader = reader
        self.header = header = ChmHeader(reader)

        with reader.detour_absolute(header.section_file_size.offset):
            self.file_size = FileSizeHeader(reader)

        with reader.detour_absolute(header.section_directory.offset):
            self.directory = dh = DirectoryHeader(reader)
            self.index = []

            d = dh.density
            m = dh.chunk_size

            self.listing: list[ListingChunk] = []

            for k in range(dh.total_chunks):
                body = reader.read_exactly(m)
                if body[:4] == IndexChunk.Magic:
                    self.index.append(IndexChunk(body, d))
                    continue
                if body[:4] == ListingChunk.Magic:
                    if not (dh.listing1st &lt;= k &lt;= dh.listingLst):
                        raise ValueError(F&#39;Chunk {k} has magic {ListingChunk.Magic.decode()} but is out of listing range.&#39;)
                    chunk = ListingChunk(body, d)
                    for entry in chunk.entries:
                        name = entry.name
                        if name.startswith(&#39;/#&#39;) or name.startswith(&#39;/$&#39;):
                            name = F&#39;/$CHM{name}&#39;
                        self.filesystem[name] = entry
                    self.listing.append(chunk)
                    continue
                raise ValueError(F&#39;Unknown chunk magic: {body[:4].hex(&#34;:&#34;)}&#39;)

        if (co := header.content_offset) is None:
            co = reader.tell()

        reader.seekset(co)
        total_size = reader.remaining_bytes
        reader.seekset(co + self.filesystem[&#39;::DataSpace/NameList&#39;].offset)
        self.content_sections = ContentSections(reader)

        for section in self.content_sections.sections:
            if section.name.lower() == &#39;uncompressed&#39;:
                self.sections.append(ContentSection(co, total_size))
                continue
            try:
                content = self.filesystem[section.path_content]
            except KeyError as KE:
                raise LookupError(F&#39;could not find content file for section {section.name}&#39;) from KE

            cs = ContentSection(content.offset, content.length)
            cs.base_section = s = content.section_index
            reader.seekset(self.sections[s].offset + cs.offset)

            if self.seekto(reader, section.path_ctrl_data):
                control_data = ContentSectionsControlData(reader)
                cs.reset_interval = control_data.reset_interval
                cs.window_size = 15 + int(math.log2(control_data.window_size))

            if self.seekto(reader, section.path_span_info):
                cs.uncompressed = reader.u64()

            if any(
                self.seekto(reader, section.path_reset_table(guid))
                for guid in (_LZX_CHM, _LZX_HLP)
            ):
                reset_table = ContentSectionsResetTable(reader)
                cs.block_offsets = reset_table.entries
                cs.block_size = reset_table.block_size

            if cs.base_section != 0:
                raise ValueError(F&#39;Invalid base section {cs.base_section}&#39;)

            self.sections.append(cs)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="refinery.lib.chm.SectionHeader"><code class="flex name class">
<span>class <span class="ident">SectionHeader</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L19-L22" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class SectionHeader(Struct):
    def __init__(self, reader: StructReader[memoryview]):
        self.offset = reader.u64()
        self.length = reader.u64()</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
</dd>
<dt id="refinery.lib.chm.LanguageMixin"><code class="flex name class">
<span>class <span class="ident">LanguageMixin</span></span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L25-L34" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class LanguageMixin:
    language: int

    @cached_property
    def codepage(self):
        return DEFAULT_CODEPAGE.get(self.language, None)

    @cached_property
    def language_name(self):
        return LCID.get(self.language, &#39;Unknown&#39;)</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.ChmHeader" href="#refinery.lib.chm.ChmHeader">ChmHeader</a></li>
<li><a title="refinery.lib.chm.DirectoryHeader" href="#refinery.lib.chm.DirectoryHeader">DirectoryHeader</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.LanguageMixin.language"><code class="name">var <span class="ident">language</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
<h3>Instance variables</h3>
<dl>
<dt id="refinery.lib.chm.LanguageMixin.codepage"><code class="name">var <span class="ident">codepage</span></code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L28-L30" class="git-link">Browse git</a>
</summary>
<pre><code class="python">@cached_property
def codepage(self):
    return DEFAULT_CODEPAGE.get(self.language, None)</code></pre>
</details>
</dd>
<dt id="refinery.lib.chm.LanguageMixin.language_name"><code class="name">var <span class="ident">language_name</span></code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L32-L34" class="git-link">Browse git</a>
</summary>
<pre><code class="python">@cached_property
def language_name(self):
    return LCID.get(self.language, &#39;Unknown&#39;)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.ChmStruct"><code class="flex name class">
<span>class <span class="ident">ChmStruct</span></span>
<span>(</span><span>reader, *args, **kwargs)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L37-L42" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class ChmStruct(Struct):
    Magic: ClassVar[bytes]

    def _check_magic(self, reader: StructReader):
        if (s := reader.peek(len(self.Magic))) != self.Magic:
            raise InvalidMagic(self, s)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.ChmHeader" href="#refinery.lib.chm.ChmHeader">ChmHeader</a></li>
<li><a title="refinery.lib.chm.Chunk" href="#refinery.lib.chm.Chunk">Chunk</a></li>
<li><a title="refinery.lib.chm.ContentSectionsControlData" href="#refinery.lib.chm.ContentSectionsControlData">ContentSectionsControlData</a></li>
<li><a title="refinery.lib.chm.DirectoryHeader" href="#refinery.lib.chm.DirectoryHeader">DirectoryHeader</a></li>
<li><a title="refinery.lib.chm.FileSizeHeader" href="#refinery.lib.chm.FileSizeHeader">FileSizeHeader</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.ChmStruct.Magic"><code class="name">var <span class="ident">Magic</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.InvalidMagic"><code class="flex name class">
<span>class <span class="ident">InvalidMagic</span></span>
<span>(</span><span>who, magic)</span>
</code></dt>
<dd>
<section class="desc"><p>Inappropriate argument value (of correct type).</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L45-L49" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class InvalidMagic(ValueError):
    def __init__(self, who: ChmStruct, magic: memoryview):
        super().__init__(
            F&#39;Invalid {who.__class__.__name__} signature {magic.hex(&#34;:&#34;).upper()}, &#39;
            F&#39;should be {who.Magic.hex(&#34;:&#34;).upper()}.&#39;)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>builtins.ValueError</li>
<li>builtins.Exception</li>
<li>builtins.BaseException</li>
</ul>
</dd>
<dt id="refinery.lib.chm.ChmHeader"><code class="flex name class">
<span>class <span class="ident">ChmHeader</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L52-L71" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class ChmHeader(ChmStruct, LanguageMixin):

    Magic = B&#39;ITSF&#39;
    Guid = UUID(&#39;7C01FD10-7BAA-11D0-9E0C-00A0-C922-E6EC&#39;)

    def __init__(self, reader: StructReader[memoryview]):
        self._check_magic(reader)
        self.signature = reader.read_bytes(4)
        self.version = v = reader.u32()
        if v &lt; 3:
            raise NotImplementedError(F&#39;Parsing of HelpV{v} not yet implemented.&#39;)
        self.header_size = reader.u32()
        self.unknown = reader.u32()
        self.timestamp = reader.u32()
        self.language = reader.u32()
        self.guid1 = reader.read_guid()
        self.guid2 = reader.read_guid()
        self.section_file_size = SectionHeader(reader)
        self.section_directory = SectionHeader(reader)
        self.content_offset = reader.u64() if v &gt;= 3 else None</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></li>
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
<li><a title="refinery.lib.chm.LanguageMixin" href="#refinery.lib.chm.LanguageMixin">LanguageMixin</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.ChmHeader.Magic"><code class="name">var <span class="ident">Magic</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ChmHeader.Guid"><code class="name">var <span class="ident">Guid</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.FileSizeHeader"><code class="flex name class">
<span>class <span class="ident">FileSizeHeader</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L74-L83" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class FileSizeHeader(ChmStruct):

    Magic = B&#39;\xFE\x01\0\0&#39;

    def __init__(self, reader: StructReader[memoryview]):
        self._check_magic(reader)
        self.signature = reader.u32()
        reader.skip(4)
        self.file_size = reader.u64()
        reader.skip(8)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></li>
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.FileSizeHeader.Magic"><code class="name">var <span class="ident">Magic</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.DirectoryHeader"><code class="flex name class">
<span>class <span class="ident">DirectoryHeader</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L86-L111" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class DirectoryHeader(ChmStruct, LanguageMixin):

    Magic = B&#39;ITSP\x01\0\0\0&#39;
    Guid = UUID(&#39;5D02926A-212E-11D0-9DF9-00A0C922E6EC&#39;)

    def __init__(self, reader: StructReader[memoryview]):
        self._check_magic(reader)
        self.signature = reader.read_bytes(4)
        self.version = reader.u32()
        if self.version != 1:
            raise NotImplementedError
        self.header_length_1 = reader.u32()
        reader.skip(4)
        self.chunk_size = reader.u32()
        self.density = reader.u32()
        self.tree_depth = reader.u32()
        self.root_chunk = reader.u32()
        self.listing1st = reader.u32()
        self.listingLst = reader.u32()
        reader.skip(4)
        self.total_chunks = reader.u32()
        self.language = reader.u32()
        if reader.read_guid() != self.Guid:
            raise NotImplementedError
        self.header_length_2 = reader.u32()
        reader.skip(12)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></li>
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
<li><a title="refinery.lib.chm.LanguageMixin" href="#refinery.lib.chm.LanguageMixin">LanguageMixin</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.DirectoryHeader.Magic"><code class="name">var <span class="ident">Magic</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.DirectoryHeader.Guid"><code class="name">var <span class="ident">Guid</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.QuickRefArea"><code class="flex name class">
<span>class <span class="ident">QuickRefArea</span></span>
<span>(</span><span>reader, n, count)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L114-L119" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class QuickRefArea(Struct):
    def __init__(self, reader: StructReader, n: int, count: int):
        self.offsets = {
            (k * n): reader.u16() for k in range(count, 0, -1)
        }
        self.num_entries = reader.u16()</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
</dd>
<dt id="refinery.lib.chm.DirectoryListingEntry"><code class="flex name class">
<span>class <span class="ident">DirectoryListingEntry</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L122-L129" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class DirectoryListingEntry(Struct):

    def __init__(self, reader: StructReader):
        ns = reader.read_7bit_encoded_int(64, bigendian=True)
        self.name = reader.read_bytes(ns).decode(&#39;utf8&#39;)
        self.section_index = reader.read_7bit_encoded_int(64, bigendian=True)
        self.offset = reader.read_7bit_encoded_int(64, bigendian=True)
        self.length = reader.read_7bit_encoded_int(64, bigendian=True)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
</dd>
<dt id="refinery.lib.chm.Chunk"><code class="flex name class">
<span>class <span class="ident">Chunk</span></span>
<span>(</span><span>reader, density)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L132-L152" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class Chunk(ChmStruct):

    def __init__(self, reader: StructReader, density: int):
        self._check_magic(reader)
        self.density = density
        with reader.detour_from_end(-2):
            self.num_entries = reader.u16()
        self.signature = reader.read_bytes(4)
        self.extra_size = reader.u32()

    def _quick_refs(self, reader: StructReader, density: int):
        n = 1 + (1 &lt;&lt; density)
        count = self.num_entries // n
        skips = reader.remaining_bytes - 2 * (count + 1)
        while skips &lt; 0:
            count -= 1
            skips += 2
        reader.skip(skips)
        self.quickref = QuickRefArea(reader, n, count)
        if self.quickref.num_entries != self.num_entries:
            raise ValueError</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></li>
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.IndexChunk" href="#refinery.lib.chm.IndexChunk">IndexChunk</a></li>
<li><a title="refinery.lib.chm.ListingChunk" href="#refinery.lib.chm.ListingChunk">ListingChunk</a></li>
</ul>
</dd>
<dt id="refinery.lib.chm.IndexChunk"><code class="flex name class">
<span>class <span class="ident">IndexChunk</span></span>
<span>(</span><span>reader, density)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L155-L161" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class IndexChunk(Chunk):

    Magic = B&#39;PMGI&#39;

    def __init__(self, reader: StructReader, density: int):
        super().__init__(reader, density)
        self._quick_refs(reader, density)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.Chunk" href="#refinery.lib.chm.Chunk">Chunk</a></li>
<li><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></li>
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.IndexChunk.Magic"><code class="name">var <span class="ident">Magic</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.ListingChunk"><code class="flex name class">
<span>class <span class="ident">ListingChunk</span></span>
<span>(</span><span>reader, density)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L164-L175" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class ListingChunk(Chunk):

    Magic = B&#39;PMGL&#39;

    def __init__(self, reader: StructReader, density: int):
        super().__init__(reader, density)
        reader.skip(4)
        self.nr_prev = reader.u32()
        self.nr_next = reader.u32()
        self.entries = [
            DirectoryListingEntry(reader) for _ in range(self.num_entries)]
        self._quick_refs(reader, density)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.Chunk" href="#refinery.lib.chm.Chunk">Chunk</a></li>
<li><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></li>
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.ListingChunk.Magic"><code class="name">var <span class="ident">Magic</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.ContentSectionsName"><code class="flex name class">
<span>class <span class="ident">ContentSectionsName</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L178-L202" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class ContentSectionsName(Struct):
    def __init__(self, reader: StructReader):
        name = reader.read_length_prefixed(16, block_size=2)
        self.name = codecs.decode(name, &#39;utf-16le&#39;)
        if (t := reader.u16()) != 0:
            raise ValueError(F&#39;Expected a zero WORD after content section name, got 0x{t:X}.&#39;)

    @property
    def path(self):
        return F&#39;::DataSpace/Storage/{self.name}/&#39;

    @property
    def path_content(self):
        return F&#39;{self.path}Content&#39;

    @property
    def path_ctrl_data(self):
        return F&#39;{self.path}ControlData&#39;

    @property
    def path_span_info(self):
        return F&#39;{self.path}SpanInfo&#39;

    def path_reset_table(self, guid: UUID):
        return F&#39;{self.path}Transform/{{{str(guid).upper()}}}/InstanceData/ResetTable&#39;</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Instance variables</h3>
<dl>
<dt id="refinery.lib.chm.ContentSectionsName.path"><code class="name">var <span class="ident">path</span></code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L185-L187" class="git-link">Browse git</a>
</summary>
<pre><code class="python">@property
def path(self):
    return F&#39;::DataSpace/Storage/{self.name}/&#39;</code></pre>
</details>
</dd>
<dt id="refinery.lib.chm.ContentSectionsName.path_content"><code class="name">var <span class="ident">path_content</span></code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L189-L191" class="git-link">Browse git</a>
</summary>
<pre><code class="python">@property
def path_content(self):
    return F&#39;{self.path}Content&#39;</code></pre>
</details>
</dd>
<dt id="refinery.lib.chm.ContentSectionsName.path_ctrl_data"><code class="name">var <span class="ident">path_ctrl_data</span></code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L193-L195" class="git-link">Browse git</a>
</summary>
<pre><code class="python">@property
def path_ctrl_data(self):
    return F&#39;{self.path}ControlData&#39;</code></pre>
</details>
</dd>
<dt id="refinery.lib.chm.ContentSectionsName.path_span_info"><code class="name">var <span class="ident">path_span_info</span></code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L197-L199" class="git-link">Browse git</a>
</summary>
<pre><code class="python">@property
def path_span_info(self):
    return F&#39;{self.path}SpanInfo&#39;</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="refinery.lib.chm.ContentSectionsName.path_reset_table"><code class="name flex">
<span>def <span class="ident">path_reset_table</span></span>(<span>self, guid)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L201-L202" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def path_reset_table(self, guid: UUID):
    return F&#39;{self.path}Transform/{{{str(guid).upper()}}}/InstanceData/ResetTable&#39;</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.ContentSections"><code class="flex name class">
<span>class <span class="ident">ContentSections</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L205-L208" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class ContentSections(Struct):
    def __init__(self, reader: StructReader):
        self.file_size = reader.u16()
        self.sections = [ContentSectionsName(reader) for _ in range(reader.u16())]</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
</dd>
<dt id="refinery.lib.chm.ContentSectionsControlData"><code class="flex name class">
<span>class <span class="ident">ContentSectionsControlData</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L211-L225" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class ContentSectionsControlData(ChmStruct):

    Magic = b&#39;LZXC&#39;

    def __init__(self, reader: StructReader[memoryview]):
        # Number of DWORDs following &#39;LZXC&#39;: Must be 6 if version is 2
        self.field_count = reader.u32()
        self._check_magic(reader)
        self.signature = reader.read_bytes(4)
        self.version = reader.u32()
        self.reset_interval = reader.u32()
        self.window_size = reader.u32()
        self.cache_size = reader.u32()
        if (unknowns := self.field_count - 5) &gt; 0:
            self.extra = [reader.u32() for _ in range(unknowns)]</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></li>
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="refinery.lib.chm.ContentSectionsControlData.Magic"><code class="name">var <span class="ident">Magic</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.ContentSectionsResetTable"><code class="flex name class">
<span>class <span class="ident">ContentSectionsResetTable</span></span>
<span>(</span><span>reader)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L228-L244" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class ContentSectionsResetTable(Struct):

    def __init__(self, reader: StructReader[memoryview]):
        start = reader.tell()
        self.version = reader.u32()
        if self.version not in {2, 3}:
            raise NotImplementedError
        n = reader.u32()
        if reader.u32() != 8:
            raise NotImplementedError
        self.header_size = reader.u32()
        self.size_uncompressed = reader.u64()
        self.size_compressed = reader.u64()
        self.block_size = reader.u64()
        if reader.tell() != self.header_size + start:
            raise NotImplementedError
        self.entries = [reader.u64() for _ in range(n)]</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
</dd>
<dt id="refinery.lib.chm.ContentSection"><code class="flex name class">
<span>class <span class="ident">ContentSection</span></span>
<span>(</span><span>offset, length, base_section=None, uncompressed=None, window_size=0, reset_interval=0, block_size=0, block_offsets=&lt;factory&gt;)</span>
</code></dt>
<dd>
<section class="desc"><p>ContentSection(offset: 'int', length: 'int', base_section: 'int | None' = None, uncompressed: 'int | None' = None, window_size: 'int' = 0, reset_interval: 'int' = 0, block_size: 'int' = 0, block_offsets: 'list' = <factory>)</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L247-L256" class="git-link">Browse git</a>
</summary>
<pre><code class="python">@dataclass
class ContentSection:
    offset: int
    length: int
    base_section: int | None = None
    uncompressed: int | None = None
    window_size: int = 0
    reset_interval: int = 0
    block_size: int = 0
    block_offsets: list = field(default_factory=list)</code></pre>
</details>
<h3>Instance variables</h3>
<dl>
<dt id="refinery.lib.chm.ContentSection.offset"><code class="name">var <span class="ident">offset</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ContentSection.length"><code class="name">var <span class="ident">length</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ContentSection.block_offsets"><code class="name">var <span class="ident">block_offsets</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ContentSection.base_section"><code class="name">var <span class="ident">base_section</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ContentSection.uncompressed"><code class="name">var <span class="ident">uncompressed</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ContentSection.window_size"><code class="name">var <span class="ident">window_size</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ContentSection.reset_interval"><code class="name">var <span class="ident">reset_interval</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="refinery.lib.chm.ContentSection.block_size"><code class="name">var <span class="ident">block_size</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="refinery.lib.chm.CHM"><code class="flex name class">
<span>class <span class="ident">CHM</span></span>
<span>(</span><span>reader, *args, **kwargs)</span>
</code></dt>
<dd>
<section class="desc"><p>A class to parse structured data. A <code><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></code> class can be instantiated
as follows:</p>
<pre><code>foo = Struct(data, bar=29)
</code></pre>
<p>The initialization routine of the structure will be called with a single argument <code>reader</code>. If
the object <code>data</code> is already a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>, then it will be passed
as <code>reader</code>. Otherwise, the argument will be wrapped in a <code><a title="refinery.lib.structures.StructReader" href="structures.html#refinery.lib.structures.StructReader">StructReader</a></code>.
Additional arguments to the struct are passed through.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L259-L377" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class CHM(Struct):

    def read_section(self, index: int) -&gt; memoryview:
        try:
            return self.section_data[index]
        except KeyError:
            cs = self.sections[index]
        if cs.base_section is None:
            with self.reader.detour(cs.offset):
                data = self.reader.read(cs.length)
        else:
            data = self.read_section(cs.base_section)[cs.offset:][:cs.length]
        if cs.window_size and cs.block_offsets:
            lzx = LzxDecoder()
            out = bytearray()
            lzx.set_params_and_alloc(cs.window_size)
            for nr, offset in enumerate(cs.block_offsets):
                if nr % cs.reset_interval == 0:
                    lzx.keep_history = False
                if nr &lt; len(cs.block_offsets) - 1:
                    length = cs.block_offsets[nr + 1] - offset
                else:
                    length = len(data) - offset
                out.extend(lzx.decompress(data[offset:][:length], cs.block_size))
                lzx.keep_history = True
            data = memoryview(out)
        self.section_data[index] = data
        return data

    def read(self, entry: DirectoryListingEntry):
        data = self.read_section(entry.section_index)
        return data[entry.offset:][:entry.length]

    def seekto(self, reader: StructReader, path: str):
        if content := self.filesystem.get(path):
            reader.seekset(self.sections[content.section_index].offset + content.offset)
            return True
        else:
            return False

    def __init__(self, reader: StructReader[memoryview], *args, **kwargs):
        self.filesystem: dict[str, DirectoryListingEntry] = {}
        self.sections: list[ContentSection] = []
        self.section_data: dict[int, memoryview] = {}

        self.reader = reader
        self.header = header = ChmHeader(reader)

        with reader.detour_absolute(header.section_file_size.offset):
            self.file_size = FileSizeHeader(reader)

        with reader.detour_absolute(header.section_directory.offset):
            self.directory = dh = DirectoryHeader(reader)
            self.index = []

            d = dh.density
            m = dh.chunk_size

            self.listing: list[ListingChunk] = []

            for k in range(dh.total_chunks):
                body = reader.read_exactly(m)
                if body[:4] == IndexChunk.Magic:
                    self.index.append(IndexChunk(body, d))
                    continue
                if body[:4] == ListingChunk.Magic:
                    if not (dh.listing1st &lt;= k &lt;= dh.listingLst):
                        raise ValueError(F&#39;Chunk {k} has magic {ListingChunk.Magic.decode()} but is out of listing range.&#39;)
                    chunk = ListingChunk(body, d)
                    for entry in chunk.entries:
                        name = entry.name
                        if name.startswith(&#39;/#&#39;) or name.startswith(&#39;/$&#39;):
                            name = F&#39;/$CHM{name}&#39;
                        self.filesystem[name] = entry
                    self.listing.append(chunk)
                    continue
                raise ValueError(F&#39;Unknown chunk magic: {body[:4].hex(&#34;:&#34;)}&#39;)

        if (co := header.content_offset) is None:
            co = reader.tell()

        reader.seekset(co)
        total_size = reader.remaining_bytes
        reader.seekset(co + self.filesystem[&#39;::DataSpace/NameList&#39;].offset)
        self.content_sections = ContentSections(reader)

        for section in self.content_sections.sections:
            if section.name.lower() == &#39;uncompressed&#39;:
                self.sections.append(ContentSection(co, total_size))
                continue
            try:
                content = self.filesystem[section.path_content]
            except KeyError as KE:
                raise LookupError(F&#39;could not find content file for section {section.name}&#39;) from KE

            cs = ContentSection(content.offset, content.length)
            cs.base_section = s = content.section_index
            reader.seekset(self.sections[s].offset + cs.offset)

            if self.seekto(reader, section.path_ctrl_data):
                control_data = ContentSectionsControlData(reader)
                cs.reset_interval = control_data.reset_interval
                cs.window_size = 15 + int(math.log2(control_data.window_size))

            if self.seekto(reader, section.path_span_info):
                cs.uncompressed = reader.u64()

            if any(
                self.seekto(reader, section.path_reset_table(guid))
                for guid in (_LZX_CHM, _LZX_HLP)
            ):
                reset_table = ContentSectionsResetTable(reader)
                cs.block_offsets = reset_table.entries
                cs.block_size = reset_table.block_size

            if cs.base_section != 0:
                raise ValueError(F&#39;Invalid base section {cs.base_section}&#39;)

            self.sections.append(cs)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="refinery.lib.structures.Struct" href="structures.html#refinery.lib.structures.Struct">Struct</a></li>
<li>typing.Generic</li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="refinery.lib.chm.CHM.read_section"><code class="name flex">
<span>def <span class="ident">read_section</span></span>(<span>self, index)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L261-L286" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def read_section(self, index: int) -&gt; memoryview:
    try:
        return self.section_data[index]
    except KeyError:
        cs = self.sections[index]
    if cs.base_section is None:
        with self.reader.detour(cs.offset):
            data = self.reader.read(cs.length)
    else:
        data = self.read_section(cs.base_section)[cs.offset:][:cs.length]
    if cs.window_size and cs.block_offsets:
        lzx = LzxDecoder()
        out = bytearray()
        lzx.set_params_and_alloc(cs.window_size)
        for nr, offset in enumerate(cs.block_offsets):
            if nr % cs.reset_interval == 0:
                lzx.keep_history = False
            if nr &lt; len(cs.block_offsets) - 1:
                length = cs.block_offsets[nr + 1] - offset
            else:
                length = len(data) - offset
            out.extend(lzx.decompress(data[offset:][:length], cs.block_size))
            lzx.keep_history = True
        data = memoryview(out)
    self.section_data[index] = data
    return data</code></pre>
</details>
</dd>
<dt id="refinery.lib.chm.CHM.read"><code class="name flex">
<span>def <span class="ident">read</span></span>(<span>self, entry)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L288-L290" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def read(self, entry: DirectoryListingEntry):
    data = self.read_section(entry.section_index)
    return data[entry.offset:][:entry.length]</code></pre>
</details>
</dd>
<dt id="refinery.lib.chm.CHM.seekto"><code class="name flex">
<span>def <span class="ident">seekto</span></span>(<span>self, reader, path)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/binref/refinery/blob/2c887cef6f2560025a1ac871b535f0d84fa3f321/refinery/lib/chm.py#L292-L297" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def seekto(self, reader: StructReader, path: str):
    if content := self.filesystem.get(path):
        reader.seekset(self.sections[content.section_index].offset + content.offset)
        return True
    else:
        return False</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="refinery.lib" href="index.html">refinery.lib</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="refinery.lib.chm.SectionHeader" href="#refinery.lib.chm.SectionHeader">SectionHeader</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.LanguageMixin" href="#refinery.lib.chm.LanguageMixin">LanguageMixin</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ChmStruct" href="#refinery.lib.chm.ChmStruct">ChmStruct</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.InvalidMagic" href="#refinery.lib.chm.InvalidMagic">InvalidMagic</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ChmHeader" href="#refinery.lib.chm.ChmHeader">ChmHeader</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.FileSizeHeader" href="#refinery.lib.chm.FileSizeHeader">FileSizeHeader</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.DirectoryHeader" href="#refinery.lib.chm.DirectoryHeader">DirectoryHeader</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.QuickRefArea" href="#refinery.lib.chm.QuickRefArea">QuickRefArea</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.DirectoryListingEntry" href="#refinery.lib.chm.DirectoryListingEntry">DirectoryListingEntry</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.Chunk" href="#refinery.lib.chm.Chunk">Chunk</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.IndexChunk" href="#refinery.lib.chm.IndexChunk">IndexChunk</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ListingChunk" href="#refinery.lib.chm.ListingChunk">ListingChunk</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ContentSectionsName" href="#refinery.lib.chm.ContentSectionsName">ContentSectionsName</a></code></h4>
<ul class="">
<li><code><a title="refinery.lib.chm.ContentSectionsName.path_reset_table" href="#refinery.lib.chm.ContentSectionsName.path_reset_table">path_reset_table</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ContentSections" href="#refinery.lib.chm.ContentSections">ContentSections</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ContentSectionsControlData" href="#refinery.lib.chm.ContentSectionsControlData">ContentSectionsControlData</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ContentSectionsResetTable" href="#refinery.lib.chm.ContentSectionsResetTable">ContentSectionsResetTable</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.ContentSection" href="#refinery.lib.chm.ContentSection">ContentSection</a></code></h4>
</li>
<li>
<h4><code><a title="refinery.lib.chm.CHM" href="#refinery.lib.chm.CHM">CHM</a></code></h4>
<ul class="">
<li><code><a title="refinery.lib.chm.CHM.read_section" href="#refinery.lib.chm.CHM.read_section">read_section</a></code></li>
<li><code><a title="refinery.lib.chm.CHM.read" href="#refinery.lib.chm.CHM.read">read</a></code></li>
<li><code><a title="refinery.lib.chm.CHM.seekto" href="#refinery.lib.chm.CHM.seekto">seekto</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>
hljs.configure({languages: []})
hljs.initHighlightingOnLoad()
</script>
</body>
</html>
